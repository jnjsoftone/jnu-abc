"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}(exports,{PLATFORM:function(){return s},TEMPLATES_ROOT:function(){return i},exe:function(){return d},exec:function(){return p},execOptions:function(){return l},getCurrentDir:function(){return u},getParentDir:function(){return a},initApp:function(){return $},removeApp:function(){return f},tree:function(){return y},unzip:function(){return g},zip:function(){return x}});const e=require("child_process"),r=/*#__PURE__*/c(require("path")),t=require("./builtin.js"),n=require("./git.js"),o=/*#__PURE__*/c(require("fs"));function c(e){return e&&e.__esModule?e:{default:e}}const i=`${process.env.DEV_ROOT}/jd-templates`??"C:/JnJ/Developments/jd-templates",s="win32"===process.platform?"win":"darwin"===process.platform?"mac":"linux"===process.platform?"linux":process.platform,l={encoding:"utf8",shell:"win32"===process.platform?"cmd.exe":"/bin/sh"},u=()=>"win"===s?((0,e.execSync)("chcp 65001>nul",{shell:"cmd.exe"}),(0,e.execSync)("cd",l).toString().trim().replace(/\\/g,"/")):(0,e.execSync)("pwd",l).toString().trim(),a=()=>"win"===s?((0,e.execSync)("chcp 65001>nul",{shell:"cmd.exe"}),r.default.dirname((0,e.execSync)("cd",l).toString().trim().replace(/\\/g,"/"))):r.default.dirname((0,e.execSync)("pwd",l).toString().trim()),p=r=>{let t=(0,e.execSync)(r,{encoding:"utf8"});return t?t.toString().trim():""},d=e=>{let r=[];return e.forEach(e=>r.push(p(e))),r},m=r=>{let{template:o,repoName:c,userName:p,description:d}=r,{fullName:m,email:f}=(0,n.findGithubAccount)(p??""),$=a(),x=u(),g="";for(let r of(g="win"===s?`xcopy "${i}\\${o}" "${c}\\" /E /I /H /Y`:`cp -r ${i}/${o} ${c}`,(0,e.execSync)(g,l),[`${c}/package.json`,`${c}/README.md`,`${c}/docs/workflow.md`,`${c}/manifest.json`,`${c}/publish.sh`,`${c}/publish.bat`]))(0,t.substituteInFile)(r,{"{{name}}":c??"","{{project-name}}":c??"","{{author}}":`${m} <${f}>`,"{{github-id}}":p??"","{{description}}":d||"","{{parent-dir}}":$,"{{current-dir}}":x});return console.log(g=`cd ${x}/${c} && npm install`),(0,e.execSync)(g,l),console.log(g=`cd ${x}/${c} && xgit -e makeRepo -u ${p} -n ${c} -d "${d}"`),(0,e.execSync)(g,l),r},f=r=>((0,e.execSync)(`xgit -e deleteRemoteRepo -u ${r.userName} -n ${r.repoName}`,l),"win"===s?(0,e.execSync)(`rmdir /s /q ${r.repoName}`,l):(0,e.execSync)(`rm -rf ${r.repoName}`,l),r),$=e=>{let{template:r,repoName:t,userName:n,description:o}=e;switch(r){case"node-simple":case"python-pipenv":break;case"ts-swc-npm":case"ts-webpack-obsidianPlugin":m(e)}return e},x=(t,n)=>{try{let o=r.default.resolve(t),c=r.default.basename(o),i=r.default.dirname(o),u=process.cwd();if("win"===s)try{process.chdir(i);let r=`${c}_temp`;for(let t of((0,e.execSync)(`xcopy "${c}" "${r}\\" /E /I /H /Y`,l),n?n.split(","):["node_modules","package-lock.json","package.json"])){let n=`${r}/${t}`;try{t.includes("/")?(0,e.execSync)(`rmdir /s /q "${n}"`,l):(0,e.execSync)(`del /q "${n}"`,l)}catch(e){console.log(`Warning: Could not remove ${t}`)}}(0,e.execSync)(`powershell -Command "Compress-Archive -Path '${r}/*' -DestinationPath '${c}.zip' -Force"`,l),(0,e.execSync)(`rmdir /s /q "${r}"`,l)}catch(e){throw console.error("Error during zip operation:",e),e}finally{process.chdir(u)}else try{process.chdir(i);let r=n?n.split(",").map(e=>`"${e}"`).join(" "):'"*/node_modules/*" ".git/*"';(0,e.execSync)(`zip -r "${c}.zip" "${c}" -x ${r}`,l)}finally{process.chdir(u)}return{folderPath:t,excluded:n}}catch(e){throw console.error("Error in zip function:",e),e}},g=(n,c="__MACOSX/,node_modules/,.DS_Store,.git/")=>{let i=u(),s=[];for(let u of(0,t.findFiles)(n,"*.zip"))try{let n;let a=`${i}/_unzip/${r.default.parse(u).name}`;if(console.log(`## extractPath: ${a}`),(0,t.makeDir)(a),"win32"===process.platform)for(let t of(n=`powershell -command "Expand-Archive -Path '${u}' -DestinationPath '${a}' -Force"`,c.split(",").map(e=>e.trim()))){let n=r.default.join(a,t.replace("/",""));t.endsWith("/")?(0,e.execSync)(`if exist "${n}" rmdir /s /q "${n}"`,l):(0,e.execSync)(`if exist "${n}" del /q "${n}"`,l)}else{let e=c.split(",").map(e=>`"${e.trim()}"`).join(" ");n=`unzip -o "${u}" -d "${a}" -x ${e}`}(0,e.execSync)(n),console.log(`압축 해제 완료: ${u} -> ${a}`);let p=(0,t.findFolders)(a).filter(e=>!e.includes("__MACOSX"));if(console.log(`### subFolders: ${p}, subFolders.length: ${p.length}, ${p[0]}`),1===p.length&&p[0].replace(a,"").includes(r.default.parse(u).name)){for(let t of(console.log(`### 중복 폴더 처리 필요: ${p}`),o.default.readdirSync(p[0]))){let n=r.default.join(p[0],t),o=r.default.join(a,t);"win32"===process.platform?(0,e.execSync)(`move "${n}" "${o}"`,l):(0,e.execSync)(`mv "${n}" "${o}"`,l)}"win32"===process.platform?(0,e.execSync)(`rmdir /s /q "${p[0]}"`,l):(0,e.execSync)(`rm -rf "${p[0]}"`,l)}s.push(a)}catch(e){console.error(`'${u}' 압축 해제 중 오류 발생:`,e.message)}return(0,t.deleteFilesInFolder)(i,"__MACOSX/",!0),s.join(",")},y=r=>{{if("win"===s){let n=r.split(",").join("|")||"node_modules|dist|_backups|_drafts|types|docs";try{let r=`powershell -NoProfile -ExecutionPolicy Bypass -Command "$OutputEncoding = [Console]::OutputEncoding = [Text.Encoding]::UTF8; tree /F /A | Select-String -NotMatch '${n}'"`;console.log("Command: ",r);let o=(0,e.execSync)(r,{encoding:"utf8",stdio:"pipe"});return console.log("Result: ",o),o&&(0,t.saveFile)("tree.txt",o,{overwrite:!0,newFile:!1,encoding:"utf8"}),o||""}catch(e){return console.error("Error executing tree command:",e),""}}let n=r?`"${r.split(",").join("|")}"`:'"node_modules|dist|_backups|_drafts|types|docs"',o=`tree -I ${n} --dirsfirst -L 3`;try{console.log("Command: ",o);let r=(0,e.execSync)(o,{encoding:"utf8",stdio:"pipe"});return r&&(0,t.saveFile)("tree.txt",r,{overwrite:!0,newFile:!1}),r||""}catch(e){return console.error("Error executing tree command:",e),""}}};